# 介绍
v8是谷歌开发的，由C++编写的一款js引擎，主要用于Chrome浏览器。目前的Node使用的也是v8引擎。除此之外市面上还有其他的js引擎。比如：
SpiderMonkey是第一款浏览器引擎，最早用于Netscape Navigator，后用于Mozilla Firefox。
JavaScriptCore是Apple的一款由C/C++编写的基于webkit的开源引擎，用于safari浏览器。
......
js引擎负责编译执行代码、内存管理、垃圾回收以及与宿主环境的交互。其实呢，一些主流的js引擎，无论是模块架构，还是对js代码的处理方式，都存在很多的相似之处，而差异主要在于对代码的优化策略。

此文的主角就是V8。下面会介绍V8解析执行js代码的大致过程、优化策略以及一些js编写建议。

# 主要模块
主流的js引擎都由4个模块组成，它们分别为：解析器(Parser)、解释器(Interpreter)、编译器(Compiler)和垃圾回收模块(Garbage Collector)。
## Parser
Parser负责将js代码转换为抽象语法树(Abstraction Syntax Tree，简称AST)，同时生成作用域。
## Interpreter
V8中的解释器叫做Ignition。它负责将AST转换成字节码(Byte Code)，并执行字节码，同时收集优化编译所需的信息。
## Compiler
V8中的编译器叫做TurboFan。它负责将部分字节码编译成机器代码，执行这些机器代码(Machine Code)。
## GC
回收程序不再使用的数据，释放内存空间。

# 执行过程
简单看一下js代码经历了什么。
v8引擎首先会通过Parser将js代码转换成AST，接着由Ignition将AST转换成字节码，热点字节码通过TurboFan转换成二进制的机器代码，之后机器代码有可能会被反编译成字节码。

## 即时编译(Just In Time，简称JIT)
从上文我们可以看到，由Ignition生成的字节码已经是可执行代码，但是v8在执行字节码的同时，还会收集信息，然后进行优化编译。

一般执行一段代码有两种方式：

一是将代码解释成字节码并逐行执行。生成字节码相对比较快，但是在执行阶段相对较慢；
二是先编译代码，生成机器代码然后执行。这种方式在编译阶段会消耗一些时间，但是执行速度比较快。

V8结合了以上两种方式，即JST。v8在主线程中，通过Ignition将AST转换成字节码并执行。同时v8会另起一个线程，用于TurboFan将热点代码优化编译成机器代码，然后直接执行机器代码。

## 优化编译与反编译
前面说到了编译器会对热点代码进行优化编译。在解释阶段，V8会收集编译所需的信息，将多次执行的代码(比如多次调用的函数)标记为热点代码。在编译阶段，V8将热点代码编译成更加高效的机器代码，之后再次执行到这段代码的时候，就可以直接执行编译后的机器代码了。

另一方面，在解释阶段收集到的优化信息会存在误差。举个函数例子。如果这个函数第一次调用时接收的参数为整数类型，那么优化编译后的代码中设定其参数就是整数类型，如果后面再调用到这个函数时，发现参数不是整数类型，那么这部分的优化代码就产生了错误，V8会将其反编译还原成字节码来执行。

## 惰性解析与预解析
V8在解析过程中，不会对函数声明进行完整的解析，而是会对其进行预解析。一来是减少解析所需时间，二来是减少解析生成的字节码和机器代码，节约内存空间。

预解析做了哪些事：
1. 函数进行语法的检查，必要时抛出语法错误。
2. 检查函数内部是否引用了外部变量。如果引用了外部变量，预解析器会将栈中的变量复制到推中，在下次执行到该函数时，直接使用堆中的变量。（由此联想到闭包。当外部函数执行结束时，执行栈会被销毁，其中的变量当然也会被销毁。但是由于内部函数在声明时，预解析器会将其引用的外部变量保存一份到堆中，所以当外部函数销毁时，内部函数仍能访问这些变量）

# 对象属性的优化
## 隐藏类Hidden Class
JS对象拥有一个隐藏类属性，用来存储对象的形态信息，包括属性的数量、对象原型的引用、属性在内存中的偏移量(offset)等。
当对象被创建时，对应的隐藏类也会被创建，此时隐藏类中没有任何属性信息；当对象添加属性时，一个新的隐藏类会被创建，注意，新隐藏类中存储是新添加的属性的信息，以及旧的隐藏类的引用。此时这个对象中的隐藏类属性会指向这个新的隐藏类，以此类推。
多个拥有相同形态的对象，会指向同一个隐藏类。因为它们的属性数量相同，属性的添加顺序相同，所以每个属性对应的数据在内存中的偏移量也是相同的，因此对于这一类对象，只需要一个隐藏类就可以表示了，节省了不少内存空间。

## 内联缓存Inline Caches


## 快属性Fast Properties

# 最佳实践
